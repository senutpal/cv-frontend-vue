name: Vue Simulator Desktop Release

on:
    pull_request:
        types: [opened, synchronize, reopened]
        paths:
            - 'src/**'
            - 'src-tauri/**'
            - 'package.json'
            - 'package-lock.json'
            - 'build-desktop.js'
            - '.github/workflows/tauri-build.yml'
    release:
        types: [created]

permissions:
    contents: write
    actions: read

concurrency:
    group: build-${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
    build-tauri:
        name: Build Desktop App (${{ matrix.platform }})
        strategy:
            fail-fast: false
            matrix:
                include:
                    - platform: 'macos-latest'
                      args: '--target aarch64-apple-darwin'
                      arch: 'arm64'
                    - platform: 'macos-latest'
                      args: '--target x86_64-apple-darwin'
                      arch: 'x64'
                    - platform: 'ubuntu-22.04'
                      args: ''
                      arch: 'x64'
                    - platform: 'windows-latest'
                      args: ''
                      arch: 'x64'

        runs-on: ${{ matrix.platform }}

        steps:
            - name: Checkout Repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 22
                  cache: 'npm'

            - name: Install Rust stable
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

            - name: Cache Rust Dependencies
              uses: Swatinem/rust-cache@v2
              with:
                  workspaces: './src-tauri'
                  key: ${{ matrix.platform }}-${{ matrix.arch }}-${{ hashFiles('**/Cargo.lock') }}

            - name: Install Platform Dependencies (Linux)
              if: matrix.platform == 'ubuntu-22.04'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y \
                    libwebkit2gtk-4.1-dev \
                    libayatana-appindicator3-dev \
                    librsvg2-dev \
                    patchelf \
                    build-essential \
                    curl \
                    wget \
                    file \
                    libssl-dev \
                    libxdo-dev \
                    pkg-config

            - name: Install Platform Dependencies (macOS)
              if: matrix.platform == 'macos-latest'
              run: |
                  brew update
                  brew install pkg-config create-dmg

            - name: Install Platform Dependencies (Windows)
              if: matrix.platform == 'windows-latest'
              shell: powershell
              run: |
                  choco install -y wixtoolset nsis webview2-runtime

            - name: Install Dependencies
              run: npm ci

            - name: Build Frontend for Desktop
              run: |
                  node build-desktop.js

            - name: Build Tauri App
              uses: tauri-apps/tauri-action@v0
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
                  TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
              with:
                  projectPath: ./src-tauri
                  args: ${{ matrix.args }}
                  releaseId: ${{ github.event.release.id }}

            - name: Code Signing Setup (Windows)
              if: matrix.platform == 'windows-latest' && github.event_name == 'release'
              shell: powershell
              env:
                  CERT_DATA: ${{ secrets.WINDOWS_CERTIFICATE_BASE64 }}
                  CERT_PASSWORD: ${{ secrets.WINDOWS_CERTIFICATE_PASSWORD }}
              run: |
                  if ([string]::IsNullOrEmpty($env:CERT_DATA)) {
                      Write-Host "No certificate configured, skipping signing"
                      exit 0
                  }
                  $certBytes = [Convert]::FromBase64String($env:CERT_DATA)
                  $certPath = "C:\temp\codesign.pfx"
                  New-Item -ItemType Directory -Force -Path C:\temp | Out-Null
                  [System.IO.File]::WriteAllBytes($certPath, $certBytes)
                  Import-PfxCertificate -FilePath $certPath -CertStoreLocation Cert:\CurrentUser\My -Password (ConvertTo-SecureString $env:CERT_PASSWORD -AsPlainText -Force)

            - name: Code Signing (Windows)
              if: matrix.platform == 'windows-latest' && github.event_name == 'release'
              shell: powershell
              env:
                  CERT_PASSWORD: ${{ secrets.WINDOWS_CERTIFICATE_PASSWORD }}
              run: |
                  if (-not (Test-Path "C:\temp\codesign.pfx")) {
                      Write-Host "No certificate found, skipping signing"
                      exit 0
                  }
                  $filesToSign = Get-ChildItem -Path "src-tauri\target\release\bundle" -Recurse -Include @("*.exe", "*.msi")
                  foreach ($file in $filesToSign) {
                    & "C:\Program Files (x86)\Windows Kits\10\bin\10.0.22000.0\x64\signtool.exe" sign `
                      /f "C:\temp\codesign.pfx" `
                      /p "$env:CERT_PASSWORD" `
                      /tr "http://timestamp.digicert.com" `
                      /td sha256 `
                      /fd sha256 `
                      $file.FullName
                  }

            - name: Code Signing Setup (macOS)
              if: matrix.platform == 'macos-latest' && github.event_name == 'release'
              env:
                  CERT_DATA: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
                  CERT_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
              run: |
                  if [ -z "$CERT_DATA" ]; then
                    echo "No certificate configured, skipping signing"
                    exit 0
                  fi
                  echo "$CERT_DATA" | base64 --decode > /tmp/developer_certificate.p12
                  security import /tmp/developer_certificate.p12 -k ~/Library/Keychains/login.keychain-db -P "$CERT_PASSWORD" -T /usr/bin/codesign
                  security set-key-partition-list -S apple-tool:,apple: -s -k "$CERT_PASSWORD" ~/Library/Keychains/login.keychain-db

            - name: Code Signing (macOS)
              if: matrix.platform == 'macos-latest' && github.event_name == 'release'
              env:
                  DEVELOPER_ID: ${{ secrets.APPLE_DEVELOPER_ID }}
              run: |
                  if [ ! -f "/tmp/developer_certificate.p12" ]; then
                    echo "No certificate found, skipping signing"
                    exit 0
                  fi
                  find src-tauri/target/release/bundle -name "*.app" -exec codesign --force --deep --sign "$DEVELOPER_ID" {} \;
                  find src-tauri/target/release/bundle -name "*.dmg" -exec codesign --force --sign "$DEVELOPER_ID" {} \;

            - name: Code Signing Setup (Linux)
              if: matrix.platform == 'ubuntu-22.04' && github.event_name == 'release'
              env:
                  GPG_KEY: ${{ secrets.GPG_KEY }}
              run: |
                  if [ -z "$GPG_KEY" ]; then
                    echo "No GPG key configured, skipping signing"
                    exit 0
                  fi
                  echo "$GPG_KEY" | base64 --decode > /tmp/gpg_private.key
                  gpg --import /tmp/gpg_private.key

            - name: Code Signing (Linux)
              if: matrix.platform == 'ubuntu-22.04' && github.event_name == 'release'
              env:
                  GPG_KEY_ID: ${{ secrets.LINUX_GPG_KEY_ID }}
              run: |
                  if [ ! -f "/tmp/gpg_private.key" ]; then
                    echo "No GPG key found, skipping signing"
                    exit 0
                  fi
                  for file in $(find src-tauri/target/release/bundle -name "*.deb" -o -name "*.AppImage"); do
                    gpg --detach-sign --armor --local-user "$GPG_KEY_ID" "$file"
                  done

            - name: Upload Build Artifacts
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: build-artifacts-${{ matrix.platform }}-${{ matrix.arch }}
                  path: |
                      src-tauri/target/**/release/bundle/
                      !src-tauri/target/**/release/bundle/**/*.dSYM/**
                  retention-days: 7
