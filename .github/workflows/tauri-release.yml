name: Manually Triggered Desktop Release

permissions:
    contents: write
    actions: read
    packages: write
    security-events: write

concurrency:
    group: desktop-release-${{ github.ref }}
    cancel-in-progress: true

on:
    push:
        branches: [feat/desktop-tauri-support]
    workflow_dispatch:
        inputs:
            version-bump:
                description: 'The type of version bump (major, minor, or patch)'
                required: true
                default: 'patch'
                type: choice
                options:
                    - patch
                    - minor
                    - major

jobs:
    version:
        runs-on: ubuntu-latest
        outputs:
            new_version: ${{ steps.bump.outputs.new_version }}
            changelog: ${{ steps.changelog.outputs.clean_changelog }}
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Configure Git
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

            - name: Compute New Version
              id: bump
              run: |
                  set -euo pipefail
                  set +o pipefail
                  LATEST_TAG=$(git tag --sort=-v:refname | head -n 1)
                  set -o pipefail
                  if [[ -z "$LATEST_TAG" ]]; then
                    LATEST_TAG="v0.0.0"
                  fi

                  if [[ "$LATEST_TAG" =~ ^v([0-9]+)\.([0-9]+)\.([0-9]+) ]]; then
                    MAJOR=${BASH_REMATCH[1]}
                    MINOR=${BASH_REMATCH[2]}
                    PATCH=${BASH_REMATCH[3]}
                  else
                    echo "Could not parse latest tag: $LATEST_TAG. Starting from v0.0.0."
                    MAJOR=0; MINOR=0; PATCH=0
                  fi

                  BUMP_TYPE="${{ github.event.inputs.version-bump }}"
                  if [ "$BUMP_TYPE" == "major" ]; then
                    MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0
                  elif [ "$BUMP_TYPE" == "minor" ]; then
                    MINOR=$((MINOR + 1)); PATCH=0
                  else
                    PATCH=$((PATCH + 1))
                  fi

                  NEW_VERSION="v$MAJOR.$MINOR.$PATCH"
                  VERSION_NO_V="$MAJOR.$MINOR.$PATCH"

                  echo "new_version=$NEW_VERSION" >> "$GITHUB_OUTPUT"
                  echo "version_no_v=$VERSION_NO_V" >> "$GITHUB_OUTPUT"
                  echo "New version will be: $NEW_VERSION"

            - name: Update Version Files
              run: |
                  VERSION_NO_V="${{ steps.bump.outputs.version_no_v }}"
                  jq --arg ver "$VERSION_NO_V" '.version = $ver' package.json > package.json.tmp && mv package.json.tmp package.json
                  jq --arg ver "$VERSION_NO_V" '.version = $ver' src-tauri/tauri.conf.json > src-tauri/tauri.conf.json.tmp && mv src-tauri/tauri.conf.json.tmp src-tauri/tauri.conf.json
                  sed -i "s/^version = \".*\"/version = \"$VERSION_NO_V\"/" src-tauri/Cargo.toml
                  echo "Updated version files to $VERSION_NO_V"

            - name: Generate Changelog
              id: changelog
              uses: TriPSs/conventional-changelog-action@v6
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  skip-on-empty: 'false'
                  skip-commit: 'true'
                  skip-version-file: 'true'
                  skip-git-pull: 'true'
                  skip-tag: 'true'
                  git-push: 'false'
                  output-file: 'false'
                  release-count: 0
                  tag-prefix: 'v'

            - name: Commit Version Bump
              run: |
                  NEW_VERSION="${{ steps.bump.outputs.new_version }}"
                  git add package.json src-tauri/tauri.conf.json src-tauri/Cargo.toml
                  git commit -m "chore: bump version to $NEW_VERSION"
                  git tag "$NEW_VERSION"
                  # git push origin HEAD:${{ github.ref_name }}
                  # git push origin "$NEW_VERSION"

    build-tauri:
        runs-on: ${{ matrix.os }}
        needs: version
        strategy:
            fail-fast: false
            matrix:
                os: [ubuntu-latest, windows-latest, macos-latest]

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  ref: ${{ github.ref_name }}
                  fetch-depth: 0

            - name: Pull latest changes
              run: git pull origin ${{ github.ref_name }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 22
                  cache: 'npm'

            - name: Install Dependencies
              run: npm ci

            - name: Setup Rust (stable)
              uses: dtolnay/rust-toolchain@stable

            - name: Cache Rust Dependencies
              uses: Swatinem/rust-cache@v2
              with:
                  workspaces: './src-tauri'

            - name: Install Linux Dependencies
              if: matrix.os == 'ubuntu-latest'
              run: |
                  sudo apt update
                  sudo apt install -y libwebkit2gtk-4.1-dev build-essential curl wget file libxdo-dev libssl-dev libayatana-appindicator3-dev librsvg2-dev

            - name: Build Tauri App
              run: |
                  npm run tauri build
              shell: bash

            - name: Upload Tauri Build Artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: release-artifacts-${{ matrix.os }}
                  path: src-tauri/target/release/bundle

    create-release:
        runs-on: ubuntu-latest
        needs: [version, build-tauri]
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  ref: ${{ github.ref_name }}

            - name: Configure Git
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

            - name: Update Repository Changelog
              run: |
                  CHANGELOG_FILE="CHANGELOG.md"
                  echo "${{ needs.version.outputs.changelog }}" > NEW_CHANGELOG.md
                  if [ -f "$CHANGELOG_FILE" ]; then
                    cat "$CHANGELOG_FILE" >> NEW_CHANGELOG.md
                  fi
                  mv NEW_CHANGELOG.md "$CHANGELOG_FILE"

            - name: Commit and Push Changelog
              run: |
                  git pull origin ${{ github.ref_name }} --rebase
                  git add CHANGELOG.md
                  git commit -m "chore: update changelog for ${{ needs.version.outputs.new_version }}" || echo "No changes"
                  # git push origin HEAD:${{ github.ref_name }}

            - name: Download all build artifacts
              uses: actions/download-artifact@v4
              with:
                  path: artifacts

            - name: Prepare Release Assets
              run: |
                  mkdir -p release-assets
                  find artifacts -type f \( -name "*.deb" -o -name "*.AppImage" -o -name "*.msi" -o -name "*.dmg" -o -name "*.exe" \) -exec cp {} release-assets/ \;
                  # Handle macOS .app bundles if necessary (usually they are inside DMG or zipped)
                  ls -l release-assets/

            - name: Create GitHub Release
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  NEW_VERSION="${{ needs.version.outputs.new_version }}"
                  echo "DRY RUN: gh release create $NEW_VERSION --title \"CircuitVerse Desktop $NEW_VERSION\" --notes \"${{ needs.version.outputs.changelog }}\" --latest release-assets/*"
